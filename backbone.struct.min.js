(function(){var h=this.Backbone,e=this._;!e&&"undefined"!==typeof require&&(e=require("underscore"));!h&&"undefined"!==typeof require&&(h=require("backbone"));var k=h.Struct=h.Model.extend({struct:{},autoInitialize:!1,nullifyEmpty:!1,clearEmpty:!1,__initAttr__:function(a,b){if(this.attributes[a])return this.attributes[a];this.attributes[a]=e.isFunction(b)?new b:new (eval(b));this.attributes[a].on("all",function(){var b,d,g;b=Array.prototype.slice.call(arguments);d=b.shift().split(":",2);g=d[1];d=
d[0];b[0]=this;b.unshift(e.isString(g)?d+":"+a+"."+g:d+":"+a);("change"===d&&!g||"add"===d||"remove"===d||"reset"===d||"sort"===d||"destroy"===d)&&this.trigger.call(this,"change",this);this.trigger.apply(this,b)},this);return this.attributes[a]},set:function(a,b,c){var d,g;if(!a)return this;"object"===typeof a?(g=a,c=b):(g={})[a]=b;c||(c={});if(!this._validate(g,c))return!1;for(d in g){b=g[d];var f=k.attrPath(d);if(this.struct[f.base]&&(e.isNumber(f.index)||e.isString(f.sub))){a=this.__initAttr__(f.base,
this.struct[f.base]);if(e.isNumber(f.index)){if(!e.isFunction(a.at))throw Error("Unexpected reference index:"+f.index);if(!(a=a.at(f.index)))throw Error("Index out of bounds:"+f.index);}return f.sub?a.set(f.sub,b,c):a.set(e.isFunction(b.toJSON)?b.toJSON():b,c)}(a=this.struct[d])?(a=this.__initAttr__(d,a),b&&e.isFunction(b.toJSON)&&(b=b.toJSON()),a.reset?a.reset(b,c):b?a.set(b,c):a.clear(c)):h.Model.prototype.set.call(this,d,b,c)}return this},get:function(a){var b=k.attrPath(a);if(this.struct[b.base]&&
(e.isNumber(b.index)||e.isString(b.sub)))return a=(a=(a=this.get(b.base))&&e.isNumber(b.index)?e.isFunction(a.at)?a.at(b.index):null:a)&&b.sub?e.isFunction(a.get)?a.get(b.sub):null:a;this.struct[a]&&this.autoInitialize&&this.__initAttr__(a,this.struct[a]);return h.Model.prototype.get.call(this,a)},toJSON:function(){var a,b,c;b=h.Model.prototype.toJSON.call(this);for(a in this.struct)c=null!=(c=this.get(a))?c.toJSON():null,this.nullifyEmpty&&e.isEmpty(c)&&(c=null),this.clearEmpty&&e.isEmpty(c)?delete b[a]:
b[a]=c;return b}},{attrPath:function(a){var b=a.split(".",2);a=b[0];var b=b[1],c;return(c=a.match(/(.+)\[(\d+)\]$/))?{base:c[1],index:parseInt(c[2],10),sub:b}:{base:a,sub:b}}});"undefined"!==typeof exports&&(exports.Struct=k)}).call(this);
